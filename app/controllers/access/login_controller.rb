class Access::LoginController < AuthenticationController

  skip_before_action :authenticate_by_mfa_cookie
  skip_before_action :authenticate_sub_env_access

  before_action :verify_recaptcha, only: [
    :password_auth,
    :send_reset_password_link
  ]

  # Sign up page load get request (to fetch dynamic data in signup page. for ex. invite related data)
  #
  # * Author: Puneet
  # * Date: 08/12/2018
  # * Reviewed By: Sunil
  #
  def sign_up_get

    ManagerManagement::Logout.new(params).perform
    # delete cookie irrespective if service response was success
    delete_cookie(GlobalConstant::Cookie.user_cookie_name)

    if params[:i_t].present?
      service_response = ManagerManagement::SignUp::GetDetails.new(params).perform
    else
      service_response = Result::Base.success({})
    end

    return render_api_response(service_response)

  end

  # Sign up Post request
  #
  # * Author: Shlok
  # * Date: 07/01/2019
  # * Reviewed By: Sunil
  #
  def sign_up_post

    utm_params_cookie = cookies[GlobalConstant::Cookie.utm_params_cookie_name.to_sym]
    if utm_params_cookie
      begin
        utm_params_cookie = JSON.parse(utm_params_cookie)
        params[:utm_params] = sanitize_params_recursively(utm_params_cookie)
      rescue
        Rails.logger.info "UTM cookie json parse failed. value is: #{utm_params_cookie}"
      end
    end

    if params[:i_t].present?
      service_response = ManagerManagement::SignUp::ByInvite.new(params).perform
    else
      # Verify recaptcha only if invite token is not passed.
      verify_captcha_response = GlobalConstant::Recaptcha.skip?(params) ?
                                    success :
                                    Google::Recaptcha.new({
                                                 'response' => params['g-recaptcha-response'].to_s,
                                                 'remoteip' => ip_address
                                               }).perform
      unless verify_captcha_response.success?
        Rails.logger.error("---- Recaptcha::Verify Error: #{verify_captcha_response.to_hash}")
        return render_api_response(verify_captcha_response)
      end

      service_response = ManagerManagement::SignUp::WithoutInvite.new(params).perform
    end

    if service_response.success?
      # NOTE: delete cookie value from data
      cookie_value = service_response.data.delete(:cookie_value)
      set_cookie(
        GlobalConstant::Cookie.user_cookie_name,
        cookie_value,
        GlobalConstant::Cookie.password_auth_expiry.from_now
      )
    end

    return render_api_response(service_response)

  end

  # Login Via Password
  #
  # * Author: Puneet
  # * Date: 08/12/2018
  # * Reviewed By: Sunil
  #
  def password_auth

    service_response = ManagerManagement::Login::PasswordAuth.new(params).perform

    if service_response.success?
      # NOTE: delete cookie value from data
      cookie_value = service_response.data.delete(:cookie_value)
      set_cookie(
          GlobalConstant::Cookie.user_cookie_name,
          cookie_value,
          GlobalConstant::Cookie.password_auth_expiry.from_now
      )
    end

    return render_api_response(service_response)

  end

  # Send Reset Password link
  #
  # * Author: Puneet
  # * Date: 15/01/2018
  # * Reviewed By: Sunil
  #
  def send_reset_password_link
    service_response = ManagerManagement::SendResetPasswordLink.new(params).perform
    return render_api_response(service_response)
  end

  # Reset Password
  #
  # * Author: Puneet
  # * Date: 15/01/2018
  # * Reviewed By: sunil
  #
  def reset_password
    service_response = ManagerManagement::ResetPassword.new(params).perform
    puts "reset_password service_response , #{service_response}"
    return render_api_response(service_response)
  end

  private

  # Verify Recaptcha
  #
  # * Author: Puneet
  # * Date: 11/12/2018
  # * Reviewed By: Sunil
  #
  def verify_recaptcha
    return if GlobalConstant::Recaptcha.skip?(params)

    service_response = Google::Recaptcha.new({
                                               'response' => params['g-recaptcha-response'].to_s,
                                               'remoteip' => ip_address
                                             }).perform

    puts "In verify_recaptcha service_response , #{service_response}"

    unless service_response.success?
      Rails.logger.error("---- Recaptcha::Verify Error: #{service_response.to_hash}")
      return render_api_response(service_response)
    end

    Rails.logger.debug('---- check_recaptcha_before_verification done')

  end

end
